/**
 * IMPORTANT NOTE:
 *
 * This file is licensed only for the use of Apple developers in providing MusicKit Web Services,
 * and is subject to the Apple Media Services Terms and Conditions and the Apple Developer Program
 * License Agreement. You may not copy, modify, re-host, or create derivative works of this file or the
 * accompanying Documentation, or any part thereof, including any updates, without Apple's written consent.
 *
 * ACKNOWLEDGEMENTS:
 * https://js-cdn.music.apple.com/musickit/v1/acknowledgements.txt
 */

!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";void 0!==typeof self&&self;function getCookie(e="",t=document.cookie){const n=t.match(new RegExp(`(?:^|;\\s*)${e}=([^;]*)`));if(n)return n[1]}function setCookie(e,t,n="",i=14,o,r){const s=new Date;o=null!=o?o:window;const a=(r=null!=r?r:/\./.test(o.location.hostname)?o.location.hostname:"").length>0?`domain=${r}; `:"";s.setTime(s.getTime()+24*i*60*60*1e3);let l="";"https:"===o.location.protocol&&(l="; secure"),o.document.cookie=`${e}=${t}; expires=${s.toUTCString()}; ${a}path=${n}${l}`}function removeCookie(e,t,n){setCookie(e,"","/",0,t,n)}function getLocalStorage(){let e;return function(){let e=!1;try{e="undefined"!=typeof localStorage}catch(t){}return e}()&&(e=localStorage),e}var e="undefined"!=typeof FastBoot?FastBoot.require("buffer").Buffer:"undefined"!=typeof process&&null!==process.versions&&null!==process.versions.node?Buffer:window.Buffer;function memoize(e){return function(...t){let n="",i=t.length;for(e._memoized=e._memoized||{};i--;){const e=t[i];n+=e===Object(e)?JSON.stringify(e):e}return n in e._memoized?e._memoized[n]:e._memoized[n]=e(...t)}}function isNodeEnvironment(e){const isDefined=e=>null!=e;return 0===arguments.length&&"undefined"!=typeof process&&(e=process),isDefined(e)&&isDefined(e.versions)&&isDefined(e.versions.node)||"undefined"!=typeof FastBoot}memoize(isNodeEnvironment()?t=>e.from(t,"base64").toString("binary"):e=>window.atob(e)),memoize(isNodeEnvironment()?t=>e.from(t).toString("base64"):e=>window.btoa(e));const debounce=(e,t=250,n={isImmediate:!1})=>{let i;return function(...o){const r=this,s=n.isImmediate&&void 0===i;void 0!==i&&clearTimeout(i),i=setTimeout((function(){i=void 0,n.isImmediate||e.apply(r,o)}),t),s&&e.apply(r,o)}};const t={CRITICAL:50,ERROR:40,WARNING:30,NOTICE:20,INFO:10,DEBUG:2,TRACE:1,NONE:0};const n={OFF:"NONE",0:"NONE","+":"INFO","++":"DEBUG",V:"DEBUG",D:"DEBUG",VERBOSE:"DEBUG",VV:"TRACE",SILLY:"TRACE","*":"TRACE"};function getLoggingLevel(e,i={}){if("number"==typeof e)return function(e){return"number"==typeof e&&Object.values(t).includes(e)}(e)?e:void 0;let o=e.toUpperCase();return i.allowShorthands&&void 0!==n[o]&&(o=n[o]),function(e){return"string"==typeof e&&void 0!==t[e.toUpperCase()]}(o)?t[o]:void 0}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),i.forEach((function(t){_defineProperty(e,t,n[t])}))}return e}function _objectSpreadProps(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const i=t.ERROR,DEFAULT_POLICY=(e,n)=>e!==t.NONE&&n>=e;class Logger{get parent(){return this._parent}get children(){return Array.from(this._children.values())}get namespace(){return void 0===this._parent?this.name:this._parent.namespace+"/"+this.name}get enabled(){return this.level!==t.NONE}get level(){var e,t,n;return null!==(n=null!==(t=this._level)&&void 0!==t?t:null===(e=this.parent)||void 0===e?void 0:e.level)&&void 0!==n?n:i}get levelName(){var e;return null!==(e=function(e){for(const[n,i]of Object.entries(t))if(e===i)return n}(this.level))&&void 0!==e?e:"UNKNOWN"}get levelPolicy(){var e,t,n;return null!==(n=null!==(t=this._levelPolicy)&&void 0!==t?t:null===(e=this.parent)||void 0===e?void 0:e.levelPolicy)&&void 0!==n?n:DEFAULT_POLICY}get handlers(){var e,t,n;return null!==(n=null!==(t=this._handlers)&&void 0!==t?t:null===(e=this.parent)||void 0===e?void 0:e.handlers)&&void 0!==n?n:{}}isEnabledFor(e){return this.levelPolicy(this.level,e)}setLevel(e){const t=getLoggingLevel(e);void 0!==t&&(this._level=t)}clearLevel(){this._level=void 0}setLevelPolicy(e){this._levelPolicy=e}clearLevelPolicy(){this._levelPolicy=void 0}addHandler(e,t){this._handlers||(this._handlers={}),this._handlers[e]=t}hasHandler(e){var t;return void 0!==(null===(t=this._handlers)||void 0===t?void 0:t[e])}removeHandler(e){void 0!==this._handlers&&(delete this._handlers[e],0===Object.keys(this._handlers).length&&this.clearHandlers())}clearHandlers(){this._handlers=void 0}createChild(e,t){const n=this._children.get(e);return void 0!==n?n:new Logger(e,_objectSpreadProps(_objectSpread({},t),{parent:this}))}linkChild(e){if(void 0!==e.parent&&e.parent!==this)throw new Error(`Logger '${e.name}' is already a child of a different parent ('${e.parent.name}')`);const t=this._children.get(e.name);if(void 0!==t&&t!==e)throw new Error(`A child with name '${e.name}' is already registered`);return void 0===t&&(this._children.set(e.name,e),e.linkParent(this)),e}unlinkChild(e){const t=this._children.get(e.name);return t===e&&(this._children.delete(e.name),t.unlinkParent()),e}getByName(e){return this._children.get(e)}getByNamespace(e){return function(e,t,n="/"){if(""===(t=t.trim())||"*"===t)return e;const i=t.split(n);i[0].trim()===e.name&&i.shift();if(0===i.length)return e;let o=e;for(;void 0!==o&&i.length>0;){const e=i.shift();o=o.getByName(e.trim())}return o}(this,e)}linkParent(e){return this.parent!==e&&(this.unlinkParent(),this._parent=e,e.linkChild(this)),this}unlinkParent(){return void 0!==this._parent&&(this._parent.unlinkChild(this),this._parent=void 0),this}log(e,t,...n){const i=getLoggingLevel(e);void 0!==i&&this.logRecord({time:Date.now(),namespace:this.namespace,level:i,message:t,args:n})}logRecord(e){if(!this.levelPolicy(this.level,e.level))return;const t=_objectSpread({namespace:this.namespace},e);for(const n of Object.values(this.handlers))n.process(t)}error(e,...n){this.log(t.ERROR,e,...n)}warning(e,...n){this.log(t.WARNING,e,...n)}warn(e,...t){this.warning(e,...t)}info(e,...n){this.log(t.INFO,e,...n)}debug(e,...n){this.log(t.DEBUG,e,...n)}trace(e,...n){this.log(t.TRACE,e,...n)}constructor(e,t){this._children=new Map,this.name=e,this._levelPolicy=null==t?void 0:t.levelPolicy,this._handlers=null==t?void 0:t.handlers,void 0!==(null==t?void 0:t.parent)&&this.linkParent(t.parent),void 0!==(null==t?void 0:t.level)&&this.setLevel(t.level)}}new Map([[t.CRITICAL,"error"],[t.ERROR,"error"],[t.WARNING,"warn"],[t.NOTICE,"warn"],[t.INFO,"log"],[t.DEBUG,"debug"]]);const o=new Logger("storekit");var r,s;!function(e){e.DEFAULT_CID="pldfltcid",e.TV_CID="pltvcid",e.RESTRICTIONS_ENABLED="itre",e.STOREFRONT_COUNTRY_CODE="itua",e.USER_TOKEN="media-user-token"}(r||(r={})),function(e){e[e.MUSIC=0]="MUSIC",e[e.PODCAST=1]="PODCAST",e[e.TV=2]="TV"}(s||(s={}));const a=["apps.apple.com","books.apple.com","fitness.apple.com","mediaauth.apple.com","multidev.apple.com","music.apple.com","one.apple.com","podcasts.apple.com","tv.apple.com","itunes.apple.com"];const l=Object.keys(r).map(e=>r[e]);function isFrameCookie(e){return-1!==l.indexOf(e)}function setFrameCookie(e,t){o.debug("auth-bridge: setFrameCookie",e,t),isFrameCookie(e)?(t=null!=t?t:"")?setCookie(e,t,"/",30):removeCookie(e):o.debug("auth-bridge: setFrameCookie ignoring",e)}(new class extends class{init(e,t){var n;this._receiveWindow=e,this._sendWindow=t,this.handleMessage=this.handleMessage.bind(this),null===(n=this._receiveWindow)||void 0===n||n.addEventListener("message",this.handleMessage)}sendMessage(e,t){const n={action:"mediakit:"+e,data:t};this._sendWindow&&this._sendWindow.postMessage(JSON.stringify(n),this._targetOrigin)}handleMessage(e){if(!this._isOriginAllowed(e.origin))return;let t;try{t=JSON.parse(e.data)}catch(i){}if(!t||!this._isNamespacedData(t))return;"*"===this._targetOrigin&&(this._targetOrigin=e.origin),o.debug("auth-bridge: handleMessage",t);const n=t.action.replace("mediakit:","");this[n]?this[n](t.data):o.debug("auth-bridge: unsupported method",n)}_isOriginAllowed(e){if(!e)return!1;const[t,n]=e.split("://");let i="";return n&&(i=n.split(":")[0],i&&(i=i.toLocaleLowerCase())),"https"===t&&!!i&&a.some(e=>i===e||i.endsWith("."+e))}_isNamespacedData(e){return e.action&&-1!==e.action.indexOf("mediakit:")}constructor(){this._targetOrigin="*"}}{destroy(){window.removeEventListener("storage",this.onStorageChange)}sendFrameInit(){this.sendMessage("frameInit")}onStorageChange(e){var t;const n=null===(t=e.key)||void 0===t?void 0:t.replace("mk-auth-bridge-storage-event-","");"cookie-updated"===n?this.debouncedRequestAuthUpdate():"auth-cleared"===n&&this.sendMessage("authClearedFromOtherFrame")}sendStorageEvent(e){const t=getLocalStorage();if(t)try{t.setItem("mk-auth-bridge-storage-event-"+e,""+Date.now())}catch(n){}}requestAuthUpdate(){const e={},t={enabled:this._enabled,cookies:e};this._cookieNames.forEach(t=>{const n=getCookie(t);n?(e[t]=n,this._enabled&&setFrameCookie(t,n)):e[t]=null}),this.sendMessage("updateAuth",t),this._enabled&&setTimeout(()=>this._cookieNames.forEach(e=>removeCookie(e,window,"apple.com")),1e3)}setCookieItem(e){const{name:t,value:n}=e;this._enabled&&setFrameCookie(t,n),this.debouncedRequestAuthUpdate(),isFrameCookie(t)&&this.sendStorageEvent("cookie-updated")}clearAuth(){let e=!1;this._cookieNames.forEach(t=>{getCookie(t)&&(e=!0),this._enabled&&removeCookie(t)}),this.requestAuthUpdate(),e&&this.sendStorageEvent("auth-cleared")}constructor(e){var t,n;super(),this._cookieNames=[...l],this._enabled=!0,e&&(t=e,n="enabled",Object.prototype.hasOwnProperty.call(Object(t),n))&&(this._enabled=e.enabled),this.debouncedRequestAuthUpdate=debounce(this.requestAuthUpdate.bind(this),2e3),this.onStorageChange=this.onStorageChange.bind(this),window.addEventListener("storage",this.onStorageChange),this.init(window,window.parent)}}).sendFrameInit()}));
